{
  "version": 3,
  "sources": ["../src/use-shiny.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport { type EventPriority } from \"rstudio-shiny/srcts/types/src/inputPolicies\";\nimport { type ShinyClass } from \"rstudio-shiny/srcts/types/src/shiny\";\nimport { debounce } from \"./utils\";\n\n/**\n * A React hook for managing a Shiny input value.\n *\n * This hook initializes a state variable with `defaultValue` and returns the\n * current value and a function to update it, similar to `React.useState`.\n *\n * When the component mounts, it waits for Shiny to initialize. Once Shiny is\n * initialized, this hook registers the input with the Shiny React registry and\n * uses debounced updates to send values to the Shiny server via\n * `window.Shiny.setInputValue()`.\n *\n * The hook supports debouncing to optimize performance by batching rapid\n * updates, and allows setting priority levels for input events.\n *\n * Note: This hook only sends data *to* Shiny. It does not automatically update\n * the React state if the input is changed on the server-side (e.g., using\n * `updateTextInput()`). For two-way binding, a custom Shiny input binding would\n * be required.\n *\n * @param id The ID that will be used for the Shiny input (`input$<id>`).\n * @param defaultValue The initial value for the input.\n * @param options Optional configuration object.\n * @param options.debounceMs Debounce delay in milliseconds for input updates\n * (default: 100).\n * @param options.priority Priority level for the input event (from Shiny's\n * EventPriority enum).\n * @returns A tuple containing the current value and a function to set the\n * value: `[value, setValue]`.\n */\nexport function useShinyInput<T>(\n  id: string,\n  defaultValue: T,\n  {\n    debounceMs = 100,\n    priority,\n  }: {\n    debounceMs?: number;\n    priority?: EventPriority;\n  } = {}\n): [T, (value: T) => void] {\n  // NOTE: It's a little odd that debounceMs and priority passed this way; the\n  // debounceMs is associated with the specific input name, and in Shiny's API,\n  // priority is associated with each individual call to setInputValue(). But\n  // here they're both associated with the input name, and also if there are\n  // multiple calls to useShinyInput(\"foo\"), then the priority will be from the\n  // first call. This all should be straightened out in the future.\n\n  const [value, setValue] = useState<T>(defaultValue);\n  const shinyInitialized = useShinyInitialized();\n\n  useEffect(() => {\n    if (!shinyInitialized) {\n      return;\n    }\n    // Don't register and set value more than once.\n    if (id in window.Shiny.reactRegistry.inputs) {\n      return;\n    }\n\n    window.Shiny.reactRegistry.registerInput(id, setValue, {\n      debounceMs,\n      priority,\n    });\n    window.Shiny.reactRegistry.setInputValue(id, value);\n    // TODO: Cleanup? in case id changes or something like that.\n  }, [id, shinyInitialized, debounceMs, priority, value]);\n\n  const setValueWrapped = useCallback(\n    (value: T) => {\n      if (!shinyInitialized) {\n        return;\n      }\n\n      window.Shiny.reactRegistry.setInputValue(id, value);\n    },\n    [shinyInitialized, id]\n  );\n\n  // useEffect(() => {\n  //   if (!shinyInitialized) {\n  //     return;\n  //   }\n\n  //   window.Shiny.setInputValue!(inputId, value);\n  // }, [shinyInitialized, inputId, value]);\n\n  return [value, setValueWrapped];\n}\n\n/**\n * Hook to receive and subscribe to Shiny output values from the server. Creates\n * a hidden DOM element and registers a custom Shiny output binding to receive\n * reactive data updates for the specified outputId.\n *\n * @param outputId The ID of the Shiny output to subscribe to.\n * @param defaultValue Optional default value to use before the first server\n * update.\n * @returns A tuple containing [value, recalculating] where:\n *   - value: The current value of the Shiny output\n *   - recalculating: Boolean indicating if the server is currently\n *     recalculating this output\n */\nexport function useShinyOutput<T>(\n  outputId: string,\n  defaultValue: T | undefined = undefined\n): [T | undefined, boolean] {\n  const [value, setValue] = useState<T | undefined>(defaultValue);\n  const [recalculating, setRecalculating] = useState<boolean>(false);\n  const shinyInitialized = useShinyInitialized();\n\n  useEffect(() => {\n    if (!shinyInitialized) {\n      return;\n    }\n    window.Shiny.reactRegistry.registerOutput(\n      outputId,\n      setValue,\n      setRecalculating\n    );\n  }, [outputId, shinyInitialized]);\n\n  return [value, recalculating];\n}\n\n// TODO: Implement useShinyOutputValue and useShinyOutputRecalculating\n// TODO: Also get error value?\n\nexport class ReactOutputBinding extends window.Shiny.OutputBinding {\n  override find(scope: HTMLElement | JQuery<HTMLElement>): JQuery<HTMLElement> {\n    return $(scope).find(\".react-shiny-output\");\n  }\n\n  override renderValue(el: HTMLElement, data: any): void {\n    window.Shiny.reactRegistry.outputs[el.id].setValueFns.forEach((fn) =>\n      fn(data)\n    );\n  }\n\n  override renderError(el: HTMLElement, err: ErrorsMessageValue): void {\n    console.log(`Error for ${el.id}: ${err}`);\n  }\n\n  override showProgress(el: HTMLElement, show: boolean): void {\n    // console.log(`Progress for ${el.id}: ${show}`);\n    window.Shiny.reactRegistry.outputs[el.id].setRecalculatingFns.forEach(\n      (fn) => fn(show)\n    );\n  }\n}\n\nwindow.Shiny.outputBindings.register(\n  new ReactOutputBinding(),\n  \"shiny.reactOutput\"\n);\n\n// Copied from shinyapp.d.ts\ntype ErrorsMessageValue = {\n  message: string;\n  call: string[];\n  type?: string[];\n};\n\ntype InputMap = {\n  [key: string]: {\n    // Input ID\n    id: string;\n    setValueFns: Array<(value: any) => void>;\n    // Possibly debounce Shiny input value setter\n    shinySetInputValueDebounced: (\n      value: any,\n      opts?: { priority?: EventPriority }\n    ) => void;\n  };\n};\n\ntype OutputMap = {\n  [key: string]: {\n    // Output ID\n    id: string;\n    setValueFns: Array<(value: any) => void>;\n    setRecalculatingFns: Array<(value: boolean) => void>;\n  };\n};\n\n// TODO: Use weakmap?\nclass ShinyReactRegistry {\n  inputs: InputMap = {};\n  outputs: OutputMap = {};\n  private bindAllScheduled = false;\n\n  constructor() {\n    window.Shiny.addCustomMessageHandler(\"shinyReactSetInputs\", (msg: any) => {\n      for (const [inputId, value] of Object.entries(msg)) {\n        if (this.inputs[inputId]) {\n          // TODO: Don't use debounced version\n          this.setInputValue(inputId, value);\n        }\n      }\n    });\n  }\n\n  registerInput(\n    inputId: string,\n    setValueFn: (value: any) => void,\n    opts: { priority?: EventPriority; debounceMs?: number } = {}\n  ) {\n    const { debounceMs = 100 } = opts;\n    const setInputValueOpts: { priority?: EventPriority } = {};\n    if (opts.priority) {\n      setInputValueOpts.priority = opts.priority;\n    }\n\n    if (!this.inputs[inputId]) {\n      this.inputs[inputId] = {\n        id: inputId,\n        setValueFns: [],\n        shinySetInputValueDebounced: debounce((value: any) => {\n          window.Shiny.setInputValue!(inputId, value, setInputValueOpts);\n        }, debounceMs),\n      };\n    }\n    this.inputs[inputId].setValueFns.push(setValueFn);\n  }\n\n  registerOutput(\n    outputId: string,\n    setValue: (value: any) => void,\n    setRecalculating: (value: boolean) => void\n  ) {\n    if (!this.outputs[outputId]) {\n      // Need to create a dummy div element with the ID, so that we have\n      // something to bind to.\n      const div = document.createElement(\"div\");\n      div.className = \"react-shiny-output\";\n      div.id = outputId;\n      div.textContent = `This is the output div for ${outputId}`;\n      // Will display: none make the output not work?\n      div.style.visibility = \"hidden\";\n      document.body.appendChild(div);\n\n      this.outputs[outputId] = {\n        id: outputId,\n        setValueFns: [],\n        setRecalculatingFns: [],\n      };\n\n      this.scheduleBindAll();\n    }\n\n    // Do we need to dedupe?\n    this.outputs[outputId].setValueFns.push(setValue);\n    this.outputs[outputId].setRecalculatingFns.push(setRecalculating);\n  }\n\n  /**\n   * Schedules a Shiny binding operation to run after DOM updates are complete.\n   *\n   * Note: I'm not sure if this is 100% reliable. I believe we need to avoid\n   * overlapping calls to bindAll(), and am not sure if requestAnimationFrame()\n   * will provide perfect reliability for this.\n   */\n  private scheduleBindAll() {\n    if (this.bindAllScheduled) {\n      return;\n    }\n\n    this.bindAllScheduled = true;\n\n    // Use requestAnimationFrame to ensure DOM updates are complete\n    requestAnimationFrame(() => {\n      window.Shiny.unbindAll?.(document.body);\n      // eslint-disable-next-line @typescript-eslint/no-floating-promises\n      window.Shiny.bindAll?.(document.body);\n      this.bindAllScheduled = false;\n    });\n  }\n\n  hasInput(inputId: string) {\n    return this.inputs[inputId] !== undefined;\n  }\n\n  setInputValue(\n    inputId: string,\n    value: any,\n    opts?: { priority?: EventPriority }\n  ) {\n    if (!this.inputs[inputId]) {\n      console.error(`Input ${inputId} not found`);\n      return;\n    }\n    this.inputs[inputId].shinySetInputValueDebounced(value, opts);\n    this.inputs[inputId].setValueFns.forEach((fn) => fn(value));\n  }\n\n  hasOutput(outputId: string) {\n    return this.outputs[outputId] !== undefined;\n  }\n}\n\ndeclare global {\n  interface Window {\n    Shiny: ShinyClass & {\n      reactRegistry: ShinyReactRegistry;\n    };\n  }\n}\n\nwindow.Shiny.reactRegistry = new ShinyReactRegistry();\n\n/**\n * A React hook that tracks whether Shiny has been initialized.\n *\n * @returns A boolean indicating whether Shiny has been initialized.\n */\nexport function useShinyInitialized(): boolean {\n  const [shinyInitialized, setShinyInitialized] = useState<boolean>(false);\n\n  useEffect(() => {\n    // eslint-disable-next-line @typescript-eslint/no-floating-promises\n    window.Shiny.initializedPromise.then(() => {\n      setShinyInitialized(true);\n    });\n  }, []);\n\n  return shinyInitialized;\n}\n"],
  "mappings": "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",
  "names": ["value"]
}
